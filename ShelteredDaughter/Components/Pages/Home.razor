@page "/"
@using ShelteredDaughter.Models
@implements IDisposable

<PageTitle>Sheltered Daughter</PageTitle>

<div class="game-container">
    @* 盤面 *@
    <div class="board">
        <div class="exit">玄関</div>
        <div class="divider divider-left"></div>
        <div class="divider divider-right"></div>

        @* 駒を配置 *@
        @foreach (var p in Pieces)
        {
            <div class="piece @(p.ColorClass) @(Selected == p ? "selected" : "")"
                 style="
                            left:@(p.X* Cell)px;
                            top:@(p.Y* Cell + (p.Y >= 5 ? WallThick : 0))px;
                            width:@(p.Width* Cell)px;
                            height:@(p.Height* Cell)px;"
                 @onclick="() => SelectPiece(p)">
                @p.Name
            </div>
        }
    </div>

    @* 操作ボタン *@
    <div class="controls">
        <div><button @onclick="() => MoveSelected(0, -1)">↑</button></div>
        <div class="controls-mid">
            <button @onclick="() => MoveSelected(-1, 0)">←</button>
            <button class="spacer" disabled></button>
            <button @onclick="() => MoveSelected(1, 0)">→</button>
        </div>
        <div><button @onclick="() => MoveSelected(0, 1)">↓</button></div>
    </div>
</div>

@* タイマーとリセット *@
<div class="info-panel">
    <span>経過時間: @Elapsed 秒</span>
    <button @onclick="ResetGame">リセット</button>
</div>

@if (!string.IsNullOrEmpty(Message))
{
    <div class="clear-message">@Message</div>
}


@* サイズの定義をC#から取得 *@
<style>
    :root {
        --cell: @($"{Cell}px");
        --wall: @($"{WallThick}px");
    }
</style>


@code {

    // サイズの定義
    private const int Cell = 80;
    private const int BoardWidth = 6;
    private const int BoardHeight = 6; // 外部を含む
    private const int WallThick = 6;   // 壁の厚さ（可視分）

    private List<Piece> Pieces = new();
    private Piece? Selected;
    private string Message = "";

    // ---------------------------
    // 初期表示
    // ---------------------------
    protected override void OnInitialized()
    {
        StartTimer();
        InitPieces();
    }

    // タイマー開始
    private System.Threading.Timer? timer;
    private int Elapsed = 0;

    private void StartTimer()
    {
        timer?.Dispose();
        timer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                Elapsed++;
                StateHasChanged();
            });
        }, null, 1000, 1000);
    }

    // 駒の初期配置
    private void InitPieces()
    {
        Pieces.Clear();
        // 駒名, X, Y, 幅, 高さ, 色クラス
        Pieces.Add(new Piece("父", 1, 0, 1, 2, "Color_父"));
        Pieces.Add(new Piece("娘", 2, 0, 2, 2, "Color_娘"));
        Pieces.Add(new Piece("母", 4, 0, 1, 2, "Color_母"));
        Pieces.Add(new Piece("手代", 0, 2, 1, 1, "Color_手代"));
        Pieces.Add(new Piece("大番頭", 1, 2, 4, 1, "Color_大番頭"));
        Pieces.Add(new Piece("兄嫁", 5, 2, 1, 1, "Color_兄嫁"));
        Pieces.Add(new Piece("丁稚", 0, 3, 1, 1, "Color_丁稚"));
        Pieces.Add(new Piece("女中", 1, 3, 2, 1, "Color_女中"));
        Pieces.Add(new Piece("番頭", 3, 3, 2, 1, "Color_番頭"));
        Pieces.Add(new Piece("丁稚", 5, 3, 1, 1, "Color_丁稚"));
        Pieces.Add(new Piece("番犬", 0, 4, 1, 1, "Color_番犬"));
        Pieces.Add(new Piece("祖父", 1, 4, 2, 1, "Color_祖父"));
        Pieces.Add(new Piece("祖母", 3, 4, 2, 1, "Color_祖母"));
        Pieces.Add(new Piece("丁稚", 5, 4, 1, 1, "Color_丁稚"));
    }

    // 駒の選択
    private void SelectPiece(Piece p) => Selected = p;

    // ---------------------------
    // 駒移動
    // ---------------------------
    private void MoveSelected(int dx, int dy)
    {
        if (Selected == null) return;

        // 警告や前回メッセージをクリア
        Message = "";

        int newX = Selected.X + dx;
        int newY = Selected.Y + dy;

        // 移動できるか？
        if (CanMove(Selected, newX, newY))
        {
            Selected.X = newX;
            Selected.Y = newY;
        }
    }

    // 駒が動けるかチェック
    private bool CanMove(Piece p, int newX, int newY)
    {
        //  ----- 盤外 -----
        if (newX < 0 || newY < 0)
            return false;

        if (newX + p.Width > BoardWidth || newY + p.Height > BoardHeight)
            return false;

        // ----- 壁から出ようとしているか？ -----
        bool crossesDown = (p.Y + p.Height == 5) && (newY + p.Height == 6);

        if (crossesDown)
        {
            // 駒全体が X=2,3 の範囲に収まっているか？
            if (newX < 2 || newX + p.Width > 4)
                return false;

            // 娘以外は出られない
            if (p.Name != "娘")
            {
                Message = "玄関を出てよいのは娘だけ";
                return false;
            }
            else
            {
                Clear();
            }
        }

        // ----- 他駒との衝突 -----
        foreach (var o in Pieces.Where(o => o != p))
        {
            bool overlapX = newX < o.X + o.Width && newX + p.Width > o.X;
            bool overlapY = newY < o.Y + o.Height && newY + p.Height > o.Y;

            if (overlapX && overlapY)
                return false; // 衝突
        }

        return true;
    }

    private void Clear()
    {
        Message = "🎉 クリア！ 🎉";
        timer?.Dispose(); // タイマー停止
    }

    // ---------------------------
    // やり直し
    // ---------------------------
    private void ResetGame()
    {
        Elapsed = 0;
        Message = "";
        InitPieces();
        StartTimer();
        StateHasChanged();
    }

    public void Dispose()
    {
        timer?.Dispose();
    }

}
